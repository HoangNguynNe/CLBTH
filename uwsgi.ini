[uwsgi]
# --- socket/pid như cũ ---
uwsgi-socket = /tmp/dmoj-site.sock
chown-socket = www-data:www-data
chmod-socket = 666
pidfile = /tmp/dmoj-site.pid

uid = clbth
gid = clbth

chdir = /home/clbth/CLBTH/
pythonpath = /home/clbth/CLBTH/
virtualenv = /home/clbth/clbth/

protocol = uwsgi
master = true
env = DJANGO_SETTINGS_MODULE=dmoj.settings
module = dmoj.wsgi:application
optimize = 2

# Ít process hơn, có threads để tận dụng chờ I/O DB/Redis
processes = 3
threads = 2
enable-threads = true
thunder-lock = true          ; giảm contention khi nhiều worker
single-interpreter = true

# Giới hạn & tự làm sạch worker "rò rỉ"
harakiri = 60                ; kill request treo >60s
max-requests = 2000          ; recycle worker sau N request
max-worker-lifetime = 7200   ; (giây) đề phòng rò rỉ dài hạn
reload-on-rss = 300          ; (MB) reload worker nếu vượt 300MB
vacuum = true
die-on-term = true

# Header lớn (nếu dùng nhiều cookie/CSRf…)
buffer-size = 65535

# --- SCALE LINH HOẠT (cheaper) ---
cheaper-algo = backlog
cheaper = 2                  ; tối thiểu 2 worker
cheaper-initial = 2
cheaper-step = 1
workers = 3                  ; tối đa 3 worker (khớp 'processes')
listen = 128                 ; hàng đợi kết nối vào socket
# (nếu muốn tự động hạ theo RAM)
cheaper-rss-limit-soft = 220M
cheaper-rss-limit-hard = 260M

# --- QUAN SÁT ---
memory-report = true
stats = /tmp/uwsgi_stats.sock
